Control Móvil universal Control Móvil universal Sistema de con trol y monitoreo desarrollado sobre redes GSM Garcés Fernando Matricula 7690 Director: Dr. Jorge Castiñeira Ing. Electrónica, 2007 Resumen E l presente proyecto consiste en el diseño de un sistema de control y monitoreo mediante telefonía celular, con la tecnología GSM. Incluye entradas analogicas para sensar diversas variables y relés para alimentar cargas con 220 VCA. Se abordan temas de punta en el mercado debido a la reciente inserción de dicha tecnología en la Argentina, que brinda un servicio de cobertura que abarca todo el territorio nacional. Se describe y explica la infraestructura del servicio GSM de voz y de datos apuntando exclusivamente al servicio de SMS, y se desarrolla el hardware necesario para implementar el sistema de control propuesto. En base al mismo, debido a la rapidez y eficiencia del servicio de mensajes de texto de los dispositivos móviles, el usuario podrá recibir al instante mensajes de aviso acerca del sistema controlado, y tomar rápidamente las acciones pertinentes. Introducción En los últimos años, la importancia creciente de las comunicaciones y el desarrollo de la tecnología de telefonía móvil ha propulsado la investigación de nuevos mecanismos de comunicación entre usuarios y aplicaciones. El desarrollo de la fase 2 del sistema global para las comunicaciones móviles (GSM-2) en 1996 hizo posible la transmisión de datos desde un móvil utilizando la red telefónica inalámbrica. El servicio de mensajes cortos (SMS) posibilita el envío y recepción de pequeños mensajes de texto que no superen los 160 Bytes a través de la red de telefonía inalámbrica. Hasta entonces, el acceso a servicios corporativos o brindados por terceros se encontraba limitado a las conexiones cableadas tradicionales. A partir de la introducción del GSM-2, la capacidad de acceso desde un conjunto de dispositivos cuyo número supera a las computadoras tradicionales ha propulsado la utilización de nuevos paradigmas de trabajo en el área del desarrollo e interconexión de aplicaciones. Conformación del sistema Se pensó en un sistema que pueda ser controlado por mensajería de texto o alternativamente mediante una llamada telefónica. El sistema autónomo debe detectar que el celular esta descargado, que cuenta o no con servicio de RED, que funciona el servicio de SMS, y además que pueda optar por una operadora u otra, según la señal que le este aportando en ese momento el sistema de red GSM. Se eligió como control del mismo a un microcontrolador de la línea PIC y un dispositivo móvil Sony-Ericsson T290, por la facilidad de programación y por la información aportada por el fabricante. El microcontrolador cuenta con las I/O necesarias para manejar las seis etapas que componen el control. Bloques del CMU Sistema de alimentación La alimentación primaria es de 12 V. La fuente genera dos tensiones. Una de 5 V para alimentar a los circuitos electrónicos, y otra para cargar automáticamente a la batería del celular, controlada por el microcontrolador. Sistema de entradas, salidas y sonda temp. Se pensó en un sistema genérico aplicable a diversas situaciones. El sistema cuenta con cinco entradas digitales, cinco  salidas de relé para alimentar cargas de 220 VAC y una entrada analógica para un sensor de temperatura tipo LM335. Sistema de respuesta vocal interactivo (IVR) Para implementar el sistema de audio se utilizó un grabador/reproductor monolítico ISD2590 (U4), en cuya EEPROM interna se memoriza el mensaje. Estos integrados tienen la particularidad de poder funcionar en modos de reproducción. Los modos utilizados son M0 "Reproducción rápida" y M4 "reproducción consecutiva". Cuando el integrado no tiene seleccionado ningún modo reproduce el mensaje en curso y una vez culminado el mensaje se reinicia el puntero de mensajes a la ubicación cero. Colocando el modo cuatro (M4) se bloquea este reinicio logrando reproducir todos los mensajes en forma consecutiva. Luego colocando además el modo cero (M0) se puede reproducir el mensaje 800 veces mas rápido, logrando así generar una reproducción rápida imperceptible para el oído humano. Cada vez que se termina de reproducir un mensaje existe un PIN llamado fin de mensaje, EOM que se coloca en valor bajo indicando que finalizo el mensaje. Debido a los costos del software aportado por el proveedor y el kit para grabar el chip se diseño un pequeño software y se desarrollo un circuito encargado de realizar la grabación en serie de los mensajes WAV previamente grabados en la PC. La salida del integrado ISD esta preparada para alimentar un parlante de 16 Ω y como la entrada de audio del móvil esta diseñada para recibir la salida de un sistema de manos libres, se la debió atenuar para no saturar el amplificador interno del equipo. Sistema de detección por DTMF La salida de audio del móvil Sony-Ericsson  envía la señal recibida a un decodificador DTMF 8870 (U5), cuya misión es interpretar los bitonos recibidos y enviar al microcontrolador el número que le corresponde. Esto sirve para que el cliente pueda ir seleccionando las opciones dentro del sistema  de voz interactivo. Interfase de comunicación con el móvil El microcontrolador PIC se comunica con el móvil por una línea serie. Una interfase hace compatible el nivel de la señal del móvil (3,6 V) con el del PIC (5V). El protocolo de comunicación que utilizan es el denominado AT Hayes. La comunicación se realiza a una velocidad de 9600 Bps, con un bit de start y uno de stop, sin retorno a cero. Etapa de selección de la s imcard Para seleccionar al chip de memoria portable del tipo de los utilizados en teléfonos celulares debe tenerse en cuenta la velocidad de la comunicación. El clock de la simcard opera en 1MHz, y en el momento autenticar cuando la red lo requiera, debe poder operar en 13MHz. Se utilizó un 74HC/HCT4053, multiplexor doble de tres canales analógicos, que admite señales sinusoidales de hasta 160 MHz. Comandos AT para controlar el CMU El móvil tiene la capacidad de interpretar distintos comandos necesarios para el control completo del equipo. Se tomo como prioridad conocer el nivel de señal de radio, el de ba tería, la empresa prestadora, la existencia de mensajes pendientes o lla madas en curso etc. Uno de los comandos que mas se utiliza es el AT+CIND?   Enviando dicho comando el móvil responde informado acerca de el porcentaje de carga de batería disponible, la intensidad de la señal recibida, información sobre si el cargador esta conectado o no, información sobre si el móvil esta registrado con servicio GSM y si está atendiendo una llamada en curso, etc. Técnica de lectura de SMS En primera instancia el equipo se configura en formato de texto. Luego según la operadora que este registrado se deberá configurar el centro de servicios para SMS. Se deberá colocar un puntero de lectura de mensaje apuntando al equipo móvil donde estarán los mensajes antes de ser leídos. Se crea un bucle de programación donde la placa consulta al móvil, en un lapso menor a 1 seg. Para determinar si existió algún cambio importante, se envía comando AT+CIND? y como ejemplo el equipo indica que la batería esta al 80 %, la señal al 100%, la batería se encuentra en correcto estado, no esta cargando, esta en silencio, hay un mensaje sin leer, no hay llamada en curso, esta registrado en área local y la bandeja de SMS no esta completa. En esta situación la placa solicita ver el mensaje. La información recibida por la misma podría ser la siguiente: el mensaje almacenado en la bandeja de entrada en la ubicación 2 no estaba leído, fue enviado del Nº 223-6893063 y recibido a las 22:57 Hs. del día 14/02/2008. En el cuerpo del mensaje se envían varios acrónimos creados para que el sistema pueda interactuar con el usuario. Para no existan inconvenientes la placa realiza el procedimiento de leer el mensaje, volcar dichos datos a la RAM y luego interpretar cada uno de los comandos enviados por el usuario. Esto favorece al cliente porque no debe enviar los acrónimos en un orden, ni tampoco uno por mensaje. Puede enviar  varias órdenes en un mismo mensaje sin problemas. Luego el CMU borra el mensaje a través de un comando  y responde al usuario que el mensaje fue procesado, cuando fue recibido y las ordenes que interpretó y modificó. Técnica de atención de llamadas Dentro de los comandos que se envían para inicializar el equipo se envía la orden para que el equipo muestre el número llamante en el momento que arribe una llamada de voz. Como la llamada no puede ser programada con anterioridad, existen comandos denominados "no solicitados" que informan al control móvil que existe un arribo de llamada. Este comando es +CRING cada  vez que la red envía el tono de llamado al T290 el móvil envía al CMU determinados datos. Entonces la placa deja de ejecutar la secuencia que estaba realizando e ingresa en la rutina de llamada donde detecta el comando +CLIP y el número llamante, lo comparara con LRF y LRC. De no existir coincidencia solicitará la clave dentro de la secuencia del IVR. Una vez tomado estos datos enviará el comando ATA para atender el llamado. Cada vez que se cambia de opción dentro del IVR el CMU consulta al T290 si la llamada esta en curso. De esta forma el cliente puede cortar en cualquier momento y el sistema no queda bloqueado, pudiendo volver a la rutina principal sin problemas. Creación del IVR Realizando esta llamada el usuario solo podrá realizar cambio de estado de las salidas, activar algún aviso de entrada, elegir en que estado de la entrada debe avisar el sistema o solicitar envió de SMS con el informe de temperatura, las demás opciones solo se podrán cambiar vía SMS. Cuando el cliente llama recibirá el siguiente mensaje "Bienvenido a control móvil universal" Si requiere clave aparecerá seguido "Ingrese su clave de seguridad seguida de la tecla numeral". Si la clave no es correcta habiendo digitado algún numero recibirá el mensaje "La clave ingresada no es valida" y se repetirá mensaje "Ingrese su clave de seguridad seguida de la tecla numeral" si el cliente no responde o ingresa nuevamente mal la clave se enviara saludo de despedida "Gracias por utilizar control móvil  universal", se enviara al móvil el comando ATH para cortar llamada y se volverá a la rutina  principal sin problemas. Si el cliente ingresa correctamente la clave pasara al segundo nivel dentro del IVR donde recibe el siguiente mensaje vocal "Digite 1 para entradas, 2 para salidas, 3 para temperatura, digite asterisco para salir". Si el cliente presiona asterisco se enviara saludo de despedida y comando ATH. Si presiona "1" se ingresara al tercer nivel del IVR,  el usuario recibirá mensaje vocal "Digite número de entrada a consultar" y seguido "Para volver al menú anterior digite asterisco". Tomemos como ejemplo que el cliente ingreso el digito "2" (Dicha entrada se encuentra en 0, el aviso activo y avisa cuando pase a 1) entonces recibirá el mensaje vocal "La entrada seleccionada se encuentra en Cero" luego seguido recibirá el mensaje "Avisa en 1, avisador activado".  Seguido el usuario recibirá el mensaje "Para cambiar estado de aviso digite 1, para cambiar nivel de aviso digite  2" por último "Para volver al menú anterior digite asterisco". Volviendo al nivel uno del IVR, si el cliente digitó 2 aparecerá el mensaje Digite número de salida a consultar" y seguido "Para volver al menú anterior digite asterisco". Si selecciona "1" y dicha salida esta cerrada indicara "La salida seleccionada se encuentra cerrada" luego "Para cambiar opción presione 1" seguido "Para volver al menú anterior digite asterisco". Por ultimo si se elige la opción de  consultar la temperatura, pueden darse dos situaciones. Si no hay número en LRC indicara "La opción no es valida". De lo contrario informará "Se envió informe de temperatura a Línea receptora  celular". Protocolo de comunicación por SMS   Para que el cliente pueda enviar un SMS para poder cambiar las opciones de la placa y configurarla, se crearon acrónimos para lograr que la misma pueda entender sus pedidos. Unos de los datos relevantes a tener en cuenta es que el usuario no tendrá que seguir ningún orden con los acrónimos que envíe, debido a que el sistema lee el mensaje lo graba en la RAM y luego lo analiza. La única regla es que debe cargar  la clave en el asunto del SMS o sino en el cuerpo del mensaje, entre paréntesis. Los acrónimos utilizados los que se detallan a continuación. Líneas LRC y LRF Dado que el cliente recibe el CMU totalmente desconfigurado, deberá informarle a placa cuales son los números donde quiere recibir  el aviso de  algún cambio en las cinco entradas digitales. Una vez cargados estos datos, si el cliente envía un SMS desde estos números o llama el sistema no le requerirá que ingrese la clave para solicitar cambios. Consulta de entradas Las entradas se podrán consultar en forma grupal en forma individual o selectiva enviando un acrónimo en el cuerpo del mensaje.  La placa responderá con un informe sobre el estado de las cinco entradas. Habilitación de aviso para entradas El cliente puede habilitar aviso de una o más entradas enviando un mensaje determinado. A continuación recibirá el mensaje de respuesta con la siguiente  leyenda "Se recibió SMS a las xx:yy hs. Se procesaron los siguientes cambios: EA1:1 HAE1:A E1:0" De esta forma se notifica al usuario que se detectó las solicitud y se efectuaron los cambios requeridos. Consulta de salidas De la misma forma que las entradas las salidas se podrán consultar en forma grupal en forma individual o selectiva enviando en el cuerpo del mensaje otro acrónimo, al  cual la placa responderá informando los  estados de las cinco salidas. Cambio de estado en las salidas El usuario podrá cambiar en cualquier momento los estados de las salidas independientemente de las entradas o la temperatura enviando otro acrónimo. Consulta valor de temperatura En cualquier momento el cliente tiene la posibilidad de consultar la temperatura de la sonda disponible en el PIN TEMP enviando el acrónimo TEMP?, y recibiendo al instante un mensaje SMS con la temperatura medida. Conclusión La utilización de la red GSM en aplicaciones industriales es relativamente reciente. Los dispositivos implantados bajo el sistema de telefonía analógico estaban muy limitados. Las funciones de control eran muy reducidas y la capacidad se limitaba a unas pocas señales, haciendo de esta limitación una falta de seguridad en el telemando y la gestión. Con la red digital GSM se abre un nuevo abanico de posibilidades para el telecontrol de equipos dispersos o en movimiento. Máquinas expendedoras que informan sobre su reposición y mantenimiento, posibilitando una mejor planificación de estas tareas. Alarmas inteligentes en automóviles y máquinas, bienes de equipo instalados en otras redes como la eléctrica o gas que exigen un control más fiable a un costo reducido, se verán beneficiados del sistema presentado. En esta tesis se ha detallado el proceso de desarrollo del sistema para diversas aplicaciones. Cada uno de los módulos que lo componen se ha diseñado por separado y, posteriormente, se han unido para su funcionamiento conjunto.  El programa del PIC es capaz de comunicarse con un teléfono móvil que se encuentra conectado a la placa usando el protocolo serie. Esta comunicación permite que el programa gestione el envío de mensajes de texto por un puerto determinado o controle una llamada entrante para interconectarlo por audio al IVR creado en integrado ISD2590. En el programa realizado se gestiona el envío de mensajes mediante la utilización de comandos AT específicos para telefonía móvil. Este tipo de diseño se presta a una diversidad ilimitada de aplicaciones, abriendo un enorme abanico de posibilidades. El sistema desarrollado es sumamente flexible, permitiendo al usuario la posibilidad de programar otras tareas en forma relativamente sencilla, sin la necesidad ser un experto en programación.  Permite controlar en forma remota, ágil y económica distintas situaciones o procesos que se dan en la vida cotidiana, lo cual se estima que facilitará su ingreso al mercado de los sistemas de control remotos. Dado que la telefonía celular es un servicio difundido en todo el país, que cuenta con tres prestadoras que cubren todo el territorio, brinda al usuario del control móvil universal la capacidad de lograr su cometido en cualquier parte dentro del mismo que cuente con cobertura de telefonía móvil. Bibliografía 1.- GSM Standards: GSM 07.05 ; GSM 03.40; GSM 07.07; GSM 11.14 http://www.mobilein.com/gsm_standards.html 2.- Microcontroladores PIC 2ª Edicion Diseño practico de aplicaciones. 3.- Manual de Comandos AT para Movil T290 www.sonyericsson.com/downloads/dg_at_2003_r4a.pdf 4.- ETSI: European Telecommunications Standards Institute www.etsi.org 5.- GSM WORLD: Pagina dedicada al asesoramiento de tecnologías GSM www.gsmworld.com 6.- Pagina Oficial de Movistar, Personal y Cti . www.movistar.com.ar; www.personal.com.ar www.cti.com.ar . 7.- Manual de Usuario de Sonyericsson T290 http://www.sonyericsson.com/cws/download/1/221/386/1193007967/T290a_UG_R1a_XL.pdf